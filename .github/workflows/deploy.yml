name: Deploy Nix Site

on:
    push:
        branches: [main]

permissions:
    contents: write

jobs:
    build-deploy:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout Source
              uses: actions/checkout@v4
              with:
                  submodules: true

            - name: Install Nix
              uses: DeterminateSystems/nix-installer-action@v16

            - name: Magic Nix Cache
              uses: DeterminateSystems/magic-nix-cache-action@v8

            - name: Build Site with Nix
              run: |
                  nix develop --command bash -c "
                    echo 'ðŸ¦€ Building inside Nix Environment...'

                    just -f ./wasm/justfile build demo

                    echo 'âš¡ Building Zola...'
                    zola build
                  "

            - name: Deploy to GitHub Pages
              uses: peaceiris/actions-gh-pages@v4
              with:
                  github_token: ${{ secrets.GITHUB_TOKEN }}
                  publish_dir: ./public
                  publish_branch: gh-pages
                  commit_message: "deploy: ${{ github.event.head_commit.message }}"
